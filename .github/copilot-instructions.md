# RWCapital Tracker - Copilot Instructions

## Project Overview
**RWCapital Tracker** is a Next.js 16 application that tracks international money transfers for RW Capital Holding. It integrates with Wise API to fetch transfer data, generates receipts (PDF), and provides public tracking pages.

### Core Tech Stack
- **Framework**: Next.js 16.1.1 (App Router, Turbopack disabled)
- **Database**: PostgreSQL via Prisma 6.19.1
- **Styling**: Tailwind CSS 4 + custom animations
- **Document Processing**: pdf-lib, pdf-parse
- **External APIs**: Wise.com (transfer tracking & webhooks)

## Architecture & Data Flow

### Three Key Domains

1. **Transaction Model** (Prisma schema)
   - `Transaction`: Core entity (publicId, wiseTransferId, amount, status)
   - `TransactionEvent`: Audit trail of status changes with timestamps
   - `Document`: Attached receipts/MT103 PDFs with fileUrl
   - Status values mapped from Wise API (PENDING, COMPLETED, etc.)

2. **Public Tracking Flow** (`/track/[slug]` & `/transaction/[publicId]`)
   - User enters publicId code on homepage
   - Dynamic metadata generation with cache-busting (`v=${timestamp}` param for OG images)
   - Displays transfer status, timeline, and recipient details

3. **Wise Integration** (3-layer approach)
   - **Fetch Layer**: `/api/transaction/fetch-wise/[publicId]` — pulls single transfer from Wise API, upserts to DB (idempotent)
   - **Webhook Handler**: `/api/webhooks/wise` — HMAC-SHA256 signature verification, updates transaction events on status changes
   - **Cron Reconciliation**: `/api/cron/reconcile-wise` — batch sync of all transfers, pagination-based (LIMIT=50)
   - Status mapping: `lib/wiseStatus.ts` converts Wise status strings to display labels

### Document Processing Pipeline
- **MT103 Parsing** (`lib/mt103/`)
  - `extractTextFromPdf()`: pdf-parse to extract raw text from PDF buffers
  - `parseMT103()`: Regex-based extraction of SWIFT fields (blocks :59, :50K, :57A, :32A)
- **Receipt Generation** (`/api/receipt/[publicId]`)
  - Generates PDF from Transaction + TransactionEvent data
  - Uses pdf-lib for layout (custom fonts, formatting)
  - Footer: "Document generated by RAVENSWOOD CAPITAL INC."

## Critical Developer Patterns

### Environment & Build
- **Dev**: `npm run dev` (NEXT_DISABLE_TURBOPACK=1 mandatory — turbopack conflicts with PDF processing)
- **Build**: `npm run build` triggers `prisma generate` first (critical dependency)
- **Postinstall**: `prisma generate` (auto-run to sync Prisma client)
- **Env required**: `DATABASE_URL`, `WISE_API_TOKEN`, `WISE_PROFILE_ID`, `WISE_WEBHOOK_SECRET`, `NODE_ENV`

### API Route Convention
All API routes handling external data use:
```typescript
export const runtime = "nodejs";  // Force Node runtime for Prisma/fetch
```
This is required for any route accessing the database or making HTTP requests.

### Idempotency Pattern
Wise integration uses `upsert` operations to handle retries safely:
```typescript
await prisma.transaction.upsert({
  where: { publicId },
  update: { /* changed fields */ },
  create: { /* new record */ }
})
```

### Signature Verification (Webhook Security)
Wise sends `x-wise-signature` header (HMAC-SHA256). Use `crypto.timingSafeEqual()` to prevent timing attacks:
```typescript
crypto.timingSafeEqual(Buffer.from(expected), Buffer.from(signature))
```

### Server-Side Async Params
Next.js 16 uses `Promise` for route params in dynamic routes:
```typescript
const { publicId } = await params;  // Always await before using
```

## Naming Conventions & Terminology
- **publicId**: User-facing transfer tracking code (displayed to clients)
- **wiseTransferId**: Internal Wise transfer ID (hidden from users)
- **WiseStatus**: TypeScript type for status values from Wise API
- **Transfer**: Wise terminology; mapped to `Transaction` in DB for consistency

## Key Files Reference
- [schema.prisma](prisma/schema.prisma) — Data model definition
- [wiseStatus.ts](lib/wiseStatus.ts) — Status mapping logic
- [wise/route.ts](app/api/webhooks/wise/route.ts) — Webhook signature verification
- [fetch-wise/route.ts](app/api/transaction/fetch-wise/) — Single transfer fetch (idempotent)
- [reconcile-wise/route.ts](app/api/cron/reconcile-wise/) — Batch sync with pagination
- [page.tsx](app/page.tsx) — Homepage with tracking code input

## Common Tasks

**Add new transaction field**: Update schema.prisma, run migrations, regenerate Prisma client.

**Handle new Wise webhook event**: Update webhook route payload parsing and TransactionEvent creation.

**Fix OG image caching**: Include `v=${timestamp}` cache-buster in `/track/[slug]/page.tsx` metadata.

**Debug PDF generation**: Check [receipt/route.ts](app/api/receipt/[publicId]/route.ts) for layout constants (PAGE_WIDTH=595, PAGE_HEIGHT=842).

**Update status mapping**: Edit [wiseStatus.ts](lib/wiseStatus.ts) — affects both UI display and cron reconciliation.
